


# ç”µå­ç­¾å
[[toc]]

## åœºæ™¯ä»‹ç»
â€‹    é¡¹ç›®å¼€å‘ä¸­ï¼Œä¸šåŠ¡éœ€æ±‚å¯èƒ½ä¼šè¦æ±‚ç”¨æˆ·åœ¨ä¸€äº›åè®®ä¸­ç­¾å­—ï¼Œè¿™æ—¶å‰ç«¯å°±è¦ç”¨åˆ°`canvas`ç»˜åˆ¶å›¾å½¢ï¼Œå¹¶å°†å®ƒç”Ÿæˆå›¾ç‰‡ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šã€‚æœ¬ç¯‡ä¸»è¦ç”¨`canvas`æ­é…`html2Canvas`ã€`JsPDF`ä¸¤ä¸ªå·¥å…·åº“å»å®ç°å®ƒã€‚

:::tip

æœ¬ç¯‡å®ç°ç¯å¢ƒï¼š`vue3.2`

:::



## å®ç°

### canvasç»˜åˆ¶

### ç»˜åˆ¶äº‹ä»¶

- `gloablAlpha` ä¸é€æ˜åº¦
- `lineWidth` çº¿å®½
- `strokeStyle` ç»˜åˆ¶æ ·å¼
- `moveTo` ã€`lineTo`èµ·ç‚¹ä¸è½ç‚¹
- `beginPath`ã€ `closePath` å¼€å§‹è·¯å¾„ã€å…³é—­è·¯å¾„
- `stroke` ç»˜åˆ¶å›¾å½¢

```js
const writing = (beginX, beginY, stopX, stopY, ctx) => {
  ctx.beginPath();

  ctx.globalAlpha = 1;
  ctx.lineWidth = 3;
  ctx.strokeStyle = "red";

  ctx.moveTo(beginX, beginY);
  ctx.lineTo(stopX, stopY);

  ctx.closePath();
  ctx.stroke();
};

```



### æ·»åŠ äº‹ä»¶ç›‘å¬--è§¦å±ç‚¹å‡»

:::warning

æ³¨æ„è¦ç¦æ­¢é»˜è®¤äº‹ä»¶çš„è§¦å‘ï¼Œé˜²æ­¢åœ¨ç‚¹å‡»æ—¶ï¼Œè§¦å‘æ‰‹æœºæœ¬èº«è‡ªå¸¦çš„ç‚¹å‡»åŠŸèƒ½ã€‚

:::

- ç§»åŠ¨ç‚¹çš„ `clientX` - `canvas`æ–‡æœ¬å¯¹è±¡æ®çª—å£å·¦ä¾§çš„è·ç¦» `==` ç‚¹æ‰€åœ¨çš„åæ ‡

```js
signDom.addEventListener("touchstart", (e) => {
    e.preventDefault();

    beginX.value = e.touches[0].clientX - signDom.offsetLeft;
    beginY.value = e.touches[0].pageY - signDom.offsetTop;
  });
```

### æ·»åŠ äº‹ä»¶ç›‘å¬--è§¦å±æ»‘åŠ¨

:::warning

æ³¨æ„è¦ç¦æ­¢é»˜è®¤äº‹ä»¶çš„è§¦å‘ï¼Œé˜²æ­¢æ»‘åŠ¨æ—¶ï¼Œè¿ç€å±å¹•ä¸€å—å„¿æ»‘åŠ¨ã€‚

:::

- ç»˜åˆ¶å‡½æ•°æ‰§è¡Œåï¼Œè¦æ›´æ–°èµ·ç‚¹å€¼ã€‚å¦åˆ™èµ·ç‚¹ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„æœ«ç‚¹ç§»åŠ¨éƒ½ä¼šç”Ÿæˆ **ä¸€æ¡å°„çº¿**
- ç§»åŠ¨ç‚¹çš„ `clientX` - `canvas`æ–‡æœ¬å¯¹è±¡æ®çª—å£å·¦ä¾§çš„è·ç¦» == ç‚¹æ‰€åœ¨çš„åæ ‡

```vue

 signDom.addEventListener("touchmove", (e) => {
    e.preventDefault();

    e = e.touches[0];

    let stopX = e.clientX - signDom.offsetLeft;
    let stopY = e.pageY - signDom.offsetTop;

    writing(beginX.value, beginY.value, stopX, stopY, ctx);

    beginX.value = stopX;
    beginY.value = stopY;
  });
```



### è½¬æ¢æˆå›¾ç‰‡ï¼Œç”ŸæˆPDF

- `allowTaint` æ˜¯å¦å…è®¸è·¨åŸŸ
- ` let imgHeight = (595.28 / canvasWidth) * canvasHeight` æ ¹æ®`A4`ä¸`canvas`å®½åº¦ï¼Œ**ç­‰æ¯”ä¾‹ç¼©æ”¾** `canvas`é«˜åº¦ã€‚ï¼ˆæ­¤æ—¶å¾€å°ç¼©ï¼‰
- `let pageHeight = (canvasWidth / 595.28) * 841.89`  æ ¹æ®`A4`ä¸`canvas`å®½åº¦ï¼Œ**ç­‰æ¯”ä¾‹ç¼©æ”¾**  é¡µé¢é«˜åº¦ã€‚ï¼ˆæ­¤æ—¶å¾€å¤§æ”¾ï¼‰
- å¦‚æœ é¡µé¢é«˜åº¦ å¤§äº å›¾ç‰‡é«˜åº¦ï¼Œåˆ™ç›´æ¥ç”Ÿæˆå›¾ç‰‡
- å¦‚æœ å›¾ç‰‡é«˜åº¦ å¤§äº é¡µé¢é«˜åº¦ï¼Œåˆ™åœ¨ç”Ÿæˆå›¾ç‰‡çš„åŒæ—¶ï¼Œå¢åŠ ç©ºç™½é¡µã€‚ä¸”`top`é¡¶éƒ¨å€¼å‘ä¸‹ç§»åŠ¨ä¸€ä¸ª`A4`é¡µé¢é«˜åº¦çš„è·ç¦»ã€‚å›¾ç‰‡é«˜åº¦å‡å°‘ä¸€ä¸ª`A4`é¡µé¢é«˜åº¦çš„è·ç¦»ã€‚

```js
const generateCanvas = () => {
  // è·å–åŒ…è£¹ä½å®ƒçš„Dom
  const dom = document.getElementById("signature-canvas");
  html2Canvas(dom, {
    allowTaint: true, // å…è®¸è¢«æ±¡æŸ“ï¼Ÿ----å…è®¸æºè·¨åŸŸ
    width: dom.offsetWidth, //è®¾ç½®è·å–åˆ°çš„canvaså®½åº¦
    height: dom.offsetHeight, //è®¾ç½®è·å–åˆ°çš„canvasé«˜åº¦
    x: 0, //é¡µé¢åœ¨æ°´å¹³æ–¹å‘æ»šåŠ¨çš„è·ç¦»
    y: 0, //é¡µé¢åœ¨å‚ç›´æ–¹å‘æ»šåŠ¨çš„è·ç¦»
  }).then((canvas) => {
    console.log("canvas",canvas);
    let canvasWidth = canvas.width;
    let canvasHeight = canvas.height;

    // canvasé«˜åº¦== è‡ªèº«å®½åº¦ä¸A4å®½åº¦æ¯”ä¾‹* A4çš„é«˜åº¦ ==  0.5 * 841 == 420
    // å›¾ç‰‡é«˜åº¦imgHeight == A4ä¸canvaså®½åº¦æ¯” * canvasè‡ªèº«é«˜ 2 * 102  == 298
    let pageHeight = (canvasWidth / 595.28) * 841.89; // ä¸€é¡µA4 pdfèƒ½æ˜¾ç¤ºçš„canvasé«˜åº¦
    let imgWidth = 595.28; // è®¾ç½®å›¾ç‰‡å®½åº¦å’ŒA4çº¸å®½åº¦ç›¸ç­‰
    let imgHeight = (595.28 / canvasWidth) * canvasHeight; //ç­‰æ¯”ä¾‹æ¢ç®—æˆA4çº¸çš„é«˜åº¦
    let totalHeight = imgHeight; // éœ€è¦æ‰“å°çš„å›¾ç‰‡æ€»é«˜åº¦ï¼Œåˆå§‹çŠ¶æ€å’Œå›¾ç‰‡é«˜åº¦ç›¸ç­‰
    let pageData = canvas.toDataURL("image/png", 1.0);
    let PDF = new JsPDF("p", "pt", "a4", true);
    if (totalHeight < pageHeight) {
      //
      PDF.addImage(pageData, "JPEG", 0, 0, imgWidth, imgHeight); // ä»é¡¶éƒ¨å¼€å§‹æ‰“å°
    } else {
      let top = 0; // æ‰“å°åˆå§‹åŒºåŸŸ
      while (totalHeight > 0) {
        PDF.addImage(pageData, "JPEG", 0, top, imgWidth, imgHeight); // ä»å›¾ç‰‡é¡¶éƒ¨å¾€ä¸‹topä½ç½®å¼€å§‹æ‰“å°
        totalHeight -= pageHeight;
        top -= 841.89;
        if (totalHeight > 0) {
          PDF.addPage(); // åŠ ä¸€é¡µ
        }
      }
    }
    PDF.save("test.pdf");
  });
};
```





## å®Œæ•´ä»£ç ç¤ºä¾‹

```vue
<script setup>
import { ref, onMounted } from "vue";
import html2Canvas from "html2canvas";
import JsPDF from 'jspdf';
const signRef = ref();
const canvaspic = ref();
let beginX = ref();
let beginY = ref();

onMounted(() => {
  startCanvas();
});

const writing = (beginX, beginY, stopX, stopY, ctx) => {
  ctx.beginPath();

  ctx.globalAlpha = 1;
  ctx.lineWidth = 3;
  ctx.strokeStyle = "red";

  ctx.moveTo(beginX, beginY);
  ctx.lineTo(stopX, stopY);

  ctx.closePath();
  ctx.stroke();
};

const startCanvas = () => {
  const signDom = document.getElementById("signature-canvas");
  const ctx = signDom.getContext("2d");

  signDom.addEventListener("touchstart", (e) => {
    e.preventDefault();

    beginX.value = e.touches[0].clientX - signDom.offsetLeft;
    beginY.value = e.touches[0].pageY - signDom.offsetTop;
  });

  signDom.addEventListener("touchmove", (e) => {
    e.preventDefault();

    e = e.touches[0];

    let stopX = e.clientX - signDom.offsetLeft;
    let stopY = e.pageY - signDom.offsetTop;

    writing(beginX.value, beginY.value, stopX, stopY, ctx);

    beginX.value = stopX;
    beginY.value = stopY;
  });
};

const generateCanvas = () => {
  // è·å–åŒ…è£¹ä½å®ƒçš„Dom
  const dom = document.getElementById("signature-canvas");
  html2Canvas(dom, {
    allowTaint: true, // å…è®¸è¢«æ±¡æŸ“ï¼Ÿ----å…è®¸æºè·¨åŸŸ
    width: dom.offsetWidth, //è®¾ç½®è·å–åˆ°çš„canvaså®½åº¦
    height: dom.offsetHeight, //è®¾ç½®è·å–åˆ°çš„canvasé«˜åº¦
    x: 0, //é¡µé¢åœ¨æ°´å¹³æ–¹å‘æ»šåŠ¨çš„è·ç¦»
    y: 0, //é¡µé¢åœ¨å‚ç›´æ–¹å‘æ»šåŠ¨çš„è·ç¦»
  }).then((canvas) => {
    console.log("canvas",canvas);
    let canvasWidth = canvas.width;
    let canvasHeight = canvas.height;

    // canvasé«˜åº¦== è‡ªèº«å®½åº¦ä¸A4å®½åº¦æ¯”ä¾‹* A4çš„é«˜åº¦ ==  0.5 * 841 == 420
    // å›¾ç‰‡é«˜åº¦imgHeight == A4ä¸canvaså®½åº¦æ¯” * canvasè‡ªèº«é«˜ 2 * 102  == 298
    let pageHeight = (canvasWidth / 595.28) * 841.89; // ä¸€é¡µA4 pdfèƒ½æ˜¾ç¤ºçš„canvasé«˜åº¦
    let imgWidth = 595.28; // è®¾ç½®å›¾ç‰‡å®½åº¦å’ŒA4çº¸å®½åº¦ç›¸ç­‰
    let imgHeight = (595.28 / canvasWidth) * canvasHeight; //ç­‰æ¯”ä¾‹æ¢ç®—æˆA4çº¸çš„é«˜åº¦
    let totalHeight = imgHeight; // éœ€è¦æ‰“å°çš„å›¾ç‰‡æ€»é«˜åº¦ï¼Œåˆå§‹çŠ¶æ€å’Œå›¾ç‰‡é«˜åº¦ç›¸ç­‰
    let pageData = canvas.toDataURL("image/png", 1.0);
    let PDF = new JsPDF("p", "pt", "a4", true);
    if (totalHeight < pageHeight) {
      //
      PDF.addImage(pageData, "JPEG", 0, 0, imgWidth, imgHeight); // ä»é¡¶éƒ¨å¼€å§‹æ‰“å°
    } else {
      let top = 0; // æ‰“å°åˆå§‹åŒºåŸŸ
      while (totalHeight > 0) {
        PDF.addImage(pageData, "JPEG", 0, top, imgWidth, imgHeight); // ä»å›¾ç‰‡é¡¶éƒ¨å¾€ä¸‹topä½ç½®å¼€å§‹æ‰“å°
        totalHeight -= pageHeight;
        top -= 841.89;
        if (totalHeight > 0) {
          PDF.addPage(); // åŠ ä¸€é¡µ
        }
      }
    }
    PDF.save("test.pdf");
  });
};
</script>

<template>
  <div id="signature-container">
    <canvas
      id="signature-canvas"
      class="signature-canvas"
      ref="signRef"
      height="150"
      witdth="300"
    ></canvas>
  </div>

  <button @click="generateCanvas">ç”ŸæˆCanvaså›¾ç‰‡</button>
  <div id="canvaspic" ref="canvaspic">
    <h3>Canvaså›¾ç‰‡ğŸ‘‡</h3>
  </div>
</template>

<style lang="scss">
.signature-canvas {
  border: 1px solid black;
}
</style>


```







## æ€»ç»“

1. é€šè¿‡å…‰æ ‡çš„`clientX`å’Œ`pageY`å€¼ï¼Œä¸`canvas`è‡ªèº«ä¸çª—å£å·¦ä¾§ã€é¡¶éƒ¨çš„å®½é«˜è·ç¦»ä¹‹å·®ï¼Œè®¡ç®—å‡º **èµ·ç‚¹** ä¸ **ç»ˆç‚¹** çš„åæ ‡ã€‚
2. `pageY` ä¸ `clientY` çš„ä¸åŒç‚¹åœ¨äºï¼Œå‰è€…åŒ…æ‹¬ **æ»šåŠ¨æ¡é«˜åº¦**ï¼Œ åè€…ä¸åŒ…æ‹¬ã€‚
3. è¦è€ƒè™‘`JsPDF`ç”Ÿæˆçš„å›¾ç‰‡é«˜åº¦æ¯”`A4`é¡µé¢é«˜åº¦å¤§çš„æƒ…å†µï¼Œä»¥é˜² **å›¾ç‰‡æ˜¾ç¤ºä¸å®Œæ•´**
4. å¯ä¸º`canvas`åŒ…è£¹ä¸€å±‚domï¼Œæ·»åŠ é€‚å½“çš„`padding`ä»¥ä¿è¯å®ƒæ˜¾ç¤ºæ—¶çš„è§‚èµæ€§ã€‚



## å‚è€ƒæ–‡ç« 

1. [JSåŸºç¡€ï¼šclientXã€pageXã€screenXã€offsetXã€clientWidthã€offsetWidth è¯¦è§£ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7063073539191996453#heading-2)
2. [Options | html2canvas (hertzen.com)](https://html2canvas.hertzen.com/configuration)
3. [Home - Documentation (githack.com)](http://raw.githack.com/MrRio/jsPDF/master/docs/index.html)

